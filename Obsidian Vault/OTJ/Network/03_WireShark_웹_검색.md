# 목적 및 환경
- 목적
	- OSI 7 layer model에 기반하여 데이터 캡슐화 과정 이해
	- 실제 통신되는 패킷 분석을 통해 네트워크 프로토콜에 대한 이해
- 환경
	- kali 리눅스에서 wireshark 툴 이용
	- http 프로토콜을 사용중인 사이트(월간인테리어)에서 "house" 검색

# wireshark

- 형식
	- OSI model기반 계층 이름(TCP/IP model 기반 계층 이름)

## 응용 계층(응용 계층)
- HTTP(Hypertext Ransfer Protocol)
	 ![[Pasted image 20251117092242.png]]
	- 사용자 데이터가 포함된 실제 메시지
	- 검색어는 GET 요청의 URL 쿼리 문자열에 평문으로 노출됨
		- `GET /home_comm/board_all_list.htm?b_a_search_str=hous HTTP/1.1`
	- 평문 전송, 암호화 없음, 서버 인증 없음
	- 80번 포트
- HTTPS(HTTP Secure)
	 ![[Pasted image 20251114165925.png]]
	- GET 요청과 검색어는 TLS(Transport Layer Security)를 통해 암호화되어 이 계층에서 보이지 않고 Application Data로 표시됨
	- TLS/SSL을 사용해 암호화 전송, SSL/TLS 인증서를 통해 서버 인증
	- 443번 포트

## 표현/세션 계층(응용 계층)
- TLS(Transport Layer Security)
	- 인터넷 상에서 데이터를 암호화하여 안전하게 통신하기 위한 보안 프로토콜
	- 데이터의 기밀성, 무결성, 인증을 보장 (MITM, 위변조 방지)
	- 이전의 SSL(Secure Sockets Layer) 프로토콜을 대체한 표준화된 기술
	- 핸드셰이크
		1. Client Hello
			- 클라이언트 -> 서버
			- 암호화 방법 목록(Cipher Suites), TLS 버전 전송
		2. Server Hello & Certificate
			- 서버 -> 클라이언트
			- 클라이언트가 제시한 목록 중 하나를 선택하여 응답
			- 서버 자신의 SSL/TLS 인증서와 공개 키를 전송
		3. Certificate Verification
			- 클라이언트는 서버의 인증서가 신뢰할 수 있는 CA에 의해 발급되었는지 확인하여 서버의 신원을 검증
		4. Key Exchange
			- 클라이언트는 서버의 공개 키를 사용해 대칭키를 암호화하여 서버에게 전송
			- 서버는 자신의 개인 키로 이를 복호화하여 동일한 대칭 키를 얻음
		5. Secure Communication
			- 이후 대칭 키를 사용하여 빠르고 안전하게 데이터를 암호화/복호화하며 통신
- 사이퍼 수트(Cipyer suite)
	- 키교환 알고리즘, 암/복호화, 인증, hash 기술을 어떤 것을 사용하지 정해둔 프로토콜
- TLS1.2
	- 수십개의 사이퍼 수트 지원(안정한 것은 얼마 안됨)
- TLS1.3
	- 이전 버전에 비해 지원되는 사이퍼 수트가 축소됨(하위버전을 호환하기 때문에 통신에는 문제 없음)
	- 핸드쉐이킹이 간소화됨(1 RTT가 줄었음)
	 ![[Pasted image 20251114170559.png]]
	- 실제 사용자 데이터(http request)가 이 계층에서 암호화됨
		- TLS 섹션을 펼쳐보면 TLS Record Protocol 헤더를 볼 수 있음
		- 이 헤더는 암호화된 데이터를 전송 계층으로 전달

## 전송 계층(전송 계층)
- TCP(Transmission Control Protocol)
	- 신뢰성 있는 연결을 제공, 데이터 순서를 보장, 오류 복구 수행
	- Header
		 ![[Pasted image 20251117105543.png]]
	 ![[Pasted image 20251117101812.png]]
	- 신뢰성 있는 데이터 전송을 위한 제어 정보가 추가됨
		- Source Port: 송신자의 포트 번호
			- 내 pc에서 요청 보내는 포트 번호: `43528` 
		- Destination Port: google 수신자의 포트 번호
			- 응답하는 서버의 포트 번호: 80(http)
		- Sequence Number
			- 데이터의 순서 확인을 위한 번호
			- 세그먼트 데이터 조각이 전체 데이터 스트림 어디에 위치하는지 식별
			- 실제 번호는 248731243이지만 상대적인 번호는 1으로 전체 데이터 스트림의 2번째에 위치한 것을 알 수 있음
		- Acknowledgement Number
			- 데이터의 수신 확인을 위한 번호
			- 수신자가 받은 데이터의 일련번호를 응답함으로써 송신자에게 어떤 데이터까지 받았는지 알려줌
			- 실제 번호는 1557362209이지만 상대적인 번호는 1으로 서버가 두 번째 데이터까지 받은 것을 알 수 있음
		- HLEN(Header Length)
			- tcp 헤더의 길이를 나타냄
			- tcp 헤더 다음의 데이터가 어디서부터 시작하는지 알 수 있음
			- tcp 헤더는 20 bytes의 길이를 가진 것을 알 수 있음
		- Flags: 연결 설정/종료 및 데이터 전송 상태(제어 정보)
			- PSH, ACK만 set되어있는 것을 알 수 있음
			- PSH(Push): 버퍼된 데이터를 즉시 수신 애플리케이션으로 전송하도록 요청하는 플래그
			- ACK(Acknowledgment): 수신 확인 번호가 유효함을 나타냄
		- Window Size: 수신자가 현재 받을 수 있는 데이터의 양(흐름 제어에 사용)
			- 현재 수신자가 받을 수 있는 데이터의 양은 64240임
		- Checksum
			- segment의 오류를 검출하기 위한 체크섬 값이 포함됨
			- checksum 값은 0x36df이고 checksum 상태는 unverified로 오류가 없는 것을 알 수 있음
		- Urgent Pointer
			- URG flag가 설정된 경우 데이터 필드에서 어디까지가 긴급 데이터인지 알려주는 포인터(마지막 긴급 데이터 바이트를 가리킴)
			- 현재 Urgent Pointer가 설정되어있지 않음(0)

## 네트워크 계층(네트워크 계층/인터넷 계층)
 ![[Pasted image 20251117143043.png]]
 ![[Pasted image 20251117122022.png]]
- IP(Internet Protocol)
	- 라우팅을 위해 출발지와 목적지 주소 정보가 추가됨
		- Version: 버전을 표시함
			- 0100(2) -> 버전 4 -> IPv4 사용함
		- IHL(Internet Header Length): 인터넷 헤더 길이
			- 이 값에 따라 옵션 필드의 유무와 길이를 알 수 있음
			- 0101(2) -> 5
			- 5 * 4(Options&Padding 값이 32bits = 4bytes) = 20 bytes
		- TOS(Type of Service): 패킷 처리의 우선 순위 결정
			- 서비스 종류 또는 혼잡 알림을 나타냄
			- DSCP(Differentiated Service Code Point)
				- 요구하는 서비스의 우선순위에 대한 유형을 나타내는 필드
				- CS0(default)~CS7까지 존재하며 숫자와 우선순위가 비례함
			- ECN(Explicit Congestion Notification)
				- 라우터가 패킷을 바로 폐기 하지 않고 최종 노드에 혼잡을 알리는 용도로 사용됨
				- 00: 패킷이 ECN 기능을 사용안함
				- 01 or 10: 보내는 측이 종단점에서 ECN 기능을 사용함
				- 11: 라우터에서 혼잡이 발생할때
			- DSCP: CS0(000 000), ECN: Not-ECT(00)
				- 우선순위 가장 낮음(default), ENC 기능 사용하지 않음
		- Total length: 종합 길이 (헤더 + 데이터)
			- IP 헤더와 데이터를 포함한 전체 패킷의 길이
			- Toal Length: 818 -> 전체 패킷의 길이는 818 바이트임
		- Identification: 패킷을 구분하기 위한 고유 번호
			- 단편화된 조각들을 구분하기 위해 고유번호가 할당됨
			- 단편화되지 않은 패킷은 단편화 되기 전에 각각 1개의 패킷별로 고유한 ID를 갖게 됨
			- 해당 패킷의 id는 4253 임
		- Flags: 단편화된 추가 패킷이 있다는 것을 알려주며 수신 측에서 해당 정보를 통해 패킷들을 재조합함
			 ![[Pasted image 20251117154829.png]]
			- Reserved bit: 예약 필드(항상 0으로 예약된 비트임)
			- DF(Don't Fregment): 분할된 패킷이 없으면 1 있으면 0
			- MF(More Fragment): 분할된 패킷이 더 있으면 1 없으면 0
		- Fragment Offset: 분할된 패킷의 순서
		- TTL(Time to Live): 패킷이 네트워크를 돌아다닐 수 있는 최대 홉(Hop) 수
			- 패킷이 네트워크에서 살아있을 수 있는 시간
			- 패킷이 라우터를 통과할 때마다 1씩 감소, 0이 되면 패킷을 폐기
			- 운영체제 별로 TTL 값이 상이함
			- TTL: 64 (kali linux)
		- Protocol: 상위 계층 프로토콜 번호 (TCP는 6)
		- Header Checksum: 헤더의 오류를 검증하기 위해 사용
			- version 필드 값부터 목적지 필드값까지 모두 더함(체크섬 필드값 제외)
			- Header Checksum: 0xf36e(c8f9) -> 62318(10)
			 ![[Pasted image 20251117164207.png]]
			- wireshark에서 체크섬 기능 활성화 가능(우클릭>preferences>IPv4>Valiate the IPv4 checksum of possible 체크)
			- unverified에서 correct으로 변경되며 검증한 것을 확인할 수 있음
		- Source Address: 내 pc의 ip 주소(송신자의 아이피)
			- 192.168.100.128
		- Destination Address: 서버의 ip 주소(수신자의 아이피)
			- 221.139.49.6

## 데이터 링크 계층(네트워크 접근 계층)

- Ethernet II (가장 일반적인 유선 LAN 프로토콜)
	 ![[Pasted image 20251117173511.png]]
	- 물리적 네트워크 내에서의 통신을 위한 정보가 추가됨
		- Source MAC Address: 내 pc의 MAC 주소
		- Destination MAC Address: 다음 홉(Hop), 내 라우터의 MAC 주소
		- Type: 상위 계층 프로토콜 유형 (IPv4는 0x0800)
		- FCS(Frame Check Sequence): 오류 검출을 위해 프레임의 끝에 추가되는 트레일러
			- 와이어샤크에서 자동으로 검증함
### **통신 방법**

- 단방향 통신
	- 송수신 측이 미리 정해져있으며 데이터는 한 방향으로만 전송되는 통신 방식
	- 예시 : 무선 호출기, 라디오, 아날로그 TV 방송, 키보드 등
- 양방향 통신
	- 데이터를 두 방향으로 송수신할 수 있는 통신 방식. 반이중과 전이중으로 나뉨
	- 반이중 통신(Half Duplex)
		- 동시에 데이터를 송수신할 수 없는 방식(송수인이 번갈아 이루어짐)
		- 예시 : 휴대용 무전기 등
	- 전이중 통신(Full Duplex)
		- 양방향 통신을 동시에 수행할 수 있음. 데이터가 양쪽으로 동시에 전송됨
		- 예시 : 전화 통화, ethernet, Wi-Fi 등

### **프로토콜**

- CSMA/CD
	- CSMA/CD(Carrier Sense Multiple Access with Collision Detection)
	- 이더넷과 같은 배포된 물리 네트워크에서 주로 사용됨
	- 충돌 감지를 통해 여러 장치가 동시에 데이터를 전송하지 않도록 제어
	- 충돌 감지/대응을 위해 물리적으로 데이터 전송을 감지하고 정지시키는 기술 사용

- CSMA/CA
	- CSMA/CA(Carrier Sense Multiple Access with Collision Avoidance)
	- 무선 네트워크에서 사용되는 프로토콜로 주로 Wi-Fi와 같은 무선 네트워크 기술에서 사용됨
	- 물리적인 충돌을 감지하기 어려운 무선 환경에서 충돌을 피하기 위한 방법 제공
	- 전송하기 전 채널이 사용 가능한지 확인하고 충돌을 피하기 위한 절차를 따름

|    **구분**     |            **CSMA/CD (Collision Detection)**             |        **CSMA/CA (Collision Avoidance)**        |
| :-----------: | :------------------------------------------------------: | :---------------------------------------------: |
|    **정의**     |                    충돌 **감지** 및 복구 방식                     |                  충돌 **회피** 방식                   |
| **사용 <br>환경** |               **유선 LAN** (이더넷, IEEE 802.3)               |         **무선 LAN** (Wi-Fi, IEEE 802.11)         |
| **작동 <br>방식** | 전송 중 충돌 발생 시, 이를 **감지**하고 송신을 중단한 후, 임의의 시간 대기 후 **재전송** | 전송 전 RTS/CTS 신호를 사용하여 충돌 가능성을 **미리 낮춥니다** (회피). |

### **MAC 주소**

- 네트워크 장비 고유 식별자
- 네트워크 인터페이스 카드(NIC)에 할당되어 있으며 이 주소를 통해 네트워크에서 데이터를 주고받는 장비를 식별함
- 형식
	- 길이 : 48bit(6byte)
	- 표현 형식 : 16진수 (ex: 00-1A-7D-DA-71-C4)
- 터미널 명령어
	- windows: `ipconfig /all`, `getmac /v`
	- Linux: `ip address==

### **주요 장비**

- 브리지
	- 두 개의 LAN을 상호 접속해 주는 통신망 연결 장치
	- 통신망 범위와 길이를 확장
- 스위치(Switch)
	- 허브와 달리 데이터 충돌이 발생하지 않음
	- 스위치가 각 포트를 독립적인 충돌 도메인으로 관리하며 한 번에 여러 통신 처리 가능
	- **연결된 장치들의 MAC 주소를 MAC 주소 테이블에 저장**함
		- 스위치가 프레임을 더 빠르고 효율적으로 전달할 수 있게 도움
		- 패킷이 특정 포트에 들어오면 해당 패킷의 **출발지 MAC 주소**와 **포트 번호**를 MAC 주소 테이블에 기록함
	- 처음 부팅할 때 네트워크 관련 정보가 없음. 이 때 패킷이 들어오면 스위치는 모든 포트로 패킷을 전송함(**Flooding**)
		- LAN에서 동작하므로 자신이 정보를 가지고 있지 않더라도 어딘가에 장비가 있을 수도 있다고 가정하고 이와 같은 작업을 수행함
	- 패킷이 들어왔을 때 도착지 MAC 주소와 자신의 MAC 테이블과 비교해서 매치되는 정보가 있으면 해당 포트로 패킷을 전달(**Forwarding**)하고 다른 포트로는 패킷을 보내지 않음(**Filtering**)
	- 스패닝 트리 프로토콜(Spanning Tree protocol, STP)
		- 루프 현상(데이터 패킷이 네트워크 내를 무한히 순환하는 현상) 방지를 위한 프로토콜
		- 루프 현상을 방지하기 위해 스위치들끼리 정보를 교환하여 가장 효율적인 통신 경로를 구성(이때 생성되는 통신 경로는 트리 구조를 띠게 됨)
- Broadcasting Storm
	- 브로드캐스트 패킷이 네트워크 내에서 무한히 순환하는 현상

### **프로토콜**

- 이더넷(ethernet)
	- LAN에서 가장 널리 사용되는 데이터링크 프로토콜 중 하나
	- IEEE 802.3(유선 LAN 기술의 표준을 정의) 표준을 기반

## 물리 계층(Physical Layer)

- 네트워크에서 데이터를 전기 신호 또는 광신호로 변환하여 전송하는 역할을 담당
### **프로토콜**
- X.21, RS-232

### **주요 장비**
- 네트워크 인터페이스 카드
	- 네트워크와 컴퓨터 사이의 물리적 연결을 담당
	- 네트워크에서 데이터를 전송하고 수신하는 역할 수행
- 리피터(Repeater)
	- 신호를 증폭하여 전송 거리를 연장하거나 신호의 품질을 유지하기 위해 사용
	- 현대의 스위치나 라우터 등의 네트워크 장비가 리피터 기능을 내장하고 있음
- 허브(Hub)
	- 여러 컴퓨터 또는 네트워크 장치를 연결하여 네트워크를 형성하는데 사용됨
	- 데이터를 받으면 그 데이터를 모든 연결된 장치로 브로드캐스트하여 전송

### **전송 매체 종류**
- 유선
	- 동축 케이블, 연선, 광섬유 케이블 등
- 무선
	- 라디오파, 지상 마이크로파, 위성 마이크로파

