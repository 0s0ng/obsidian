# 1. 기반 아키텍처

![[Pasted image 20251218142140.png]]

# 2. VM 환경 구축(Vagrant)

Vagrant를 이용하여 위의 아키텍처에 기반해 필요한 서버를 빠르게 생성합니다.
이 문서는 Windows 환경 기반으로 작성된 핸즈온 문서입니다.

## 2.1 Vagrantfile 생성

`Vagrantfile`
```Plain text
# -*- mode: ruby -*-
# vi: set ft=ruby :

# common variables
BOX_NAME = "nobreak-labs/rocky-9"
MEMORY = "1024"
CPUS = 2

# IP config
NODES = {
  "WP-LB01" => { 
    networks: [
      { ip: "192.168.56.10" },
      { ip: "192.168.57.10" }
    ]
  },
  "WP-WEB01" => { 
    networks: [
      { ip: "192.168.57.11" },
      { ip: "192.168.58.11" }
    ]
  },
  "WP-WEB02" => { 
    networks: [
      { ip: "192.168.57.12" },
      { ip: "192.168.58.12" }
    ]
  },
  "WP-DB01" => { 
    networks: [
      { ip: "192.168.58.13" }
    ]
  },
  "WP-NFS01" => { 
    networks: [
      { ip: "192.168.57.14" }
    ],
    disk: { size: "10GB", name: "sdb" }
  },
  "WP-iSCSI01" => { 
    networks: [
      { ip: "192.168.58.15" }
    ],
    disk: { size: "10GB", name: "sdb" }
  }
}

Vagrant.configure("2") do |config|
  
  NODES.each do |node_name, node_config|
    config.vm.define node_name do |node|
      node.vm.box = BOX_NAME
      
      # Network config
      node_config[:networks].each do |network|
        node.vm.network "private_network", ip: network[:ip]
      end
      
      node.vm.synced_folder ".", "/vagrant", disabled: true
      
      node.vm.provider "virtualbox" do |vb|
        vb.memory = MEMORY
        vb.cpus = CPUS
        vb.name = node_name
      end
      
      node.vm.hostname = node_name
      
      # Add disk
      if node_config[:disk]
        node.vm.disk :disk, size: node_config[:disk][:size], name: node_config[:disk][:name]
      end
    end
  end
end
```

## 2.2 구축 순서

- 의존성을 고려해 데이터가 저장되는 스토리지, DB부터 상향식 구축

# 3. iSCSI target 구축

iSCSI(internet Small Computer System Interface) 서버는 DB 서버의 스토리지 확장성 및 블록 수준의 데이터 처리 성능을 확보하기 위해 구축합니다.

## 3.1 iSCSI target 서버 접속

```PowerShell
vagrant ssh WP-iSCSI01
```

## 3.2 iSCSI target 패키지 설치 및 활성화

```Bash
sudo dnf install -y targetcli
sudo systemctl enable --now target
```

## 3.3 공유 블록 생성

```Bash
lsblk
sudo targetcli
/backstores/block create name=iSCSI_disk1 dev=/dev/sdb
```

- `lsblk`: 공유할 빈 디스크가 있는지 확인
- iSCSI 저장소 유형
	- fileio: 로컬 파일 시스템에서 일반 파일을 디스크 이미지로 사용
	- block: 로컬 블록 장치 및 논리적 장치를 사용
	- pscsi: 스토리지 오브젝트 SCSI 명령의 직접 패스스루를 지원
	- ramdisk: 임시 RAM 백업 장치를 생성

## 3.4 서버 주소 생성 및 연결

### 3.4.1 iSCSI target 주소 생성

```Bash
/iscsi create iqn.2025-12.com.iscsi:wp-iscsi01.target
```

### 3.4.2 ACL 생성

```Bash
cd /iscsi/iqn.2025-12.com.iscsi:wp-iscsi01.target/tpg1/acls
create iqn.2025-12.com.iscsi:wp-db01.initiator
```

### 3.4.3 LUN(Logical Unit Number) 생성 및 연결

```Bash
cd ../luns
create /backstores/block/iSCSI_disk1
```

### 3.4.4 설정 확인

```Bash
ls /
```

```Plain Text
o- / ............................................................... [...]
  o- backstores .................................................... [...]
  | o- block .........................................[Storage Objects: 1]
  | | o- iSCSI_disk1 ............[/dev/sdb (10.0GiB) write-thru activated]
  | |   o- alua ..........................................[ALUA Groups: 1]
  | |     o- default_tg_pt_gp ..............[ALUA state: Active/optimized]
  | o- fileio ........................................[Storage Objects: 0]
  | o- pscsi .........................................[Storage Objects: 0]
  | o- ramdisk .......................................[Storage Objects: 0]
  o- iscsi ...................................................[Targets: 1]
  | o- iqn.2025-12.com.iscsi:wp-iscsi01.target ..................[TPGs: 1]
  |   o- tpg1 ......................................[no-gen-acls, no-auth]
  |     o- acls .................................................[ACLs: 1]
  |     | o- iqn.2025-12.com.iscsi:wp-db01.initiator......[Mapped LUNs: 1]
  |     |   o- mapped_lun0 ..................[lun0 block/iSCSI_disk1 (rw)]
  |     o- luns .................................................[LUNs: 1]
  |     | o- lun0 .......[block/iSCSI_disk1 (/dev/sdb) (default_tg_pt_gp)]
  |     o- portals ...........................................[Portals: 1]
  |       o- 0.0.0.0:3260 ............................................[OK]
  o- loopback ................................................[Targets: 0]
```

### 3.4.5 설정 저장 및 targetcli 접속 종료

```Bash
/ saveconfig
exit
```

## 3.5 방화벽 설정 및 접속 종료

### 3.5.1 방화벽에서 iSCSI target 서비스 열기

```Bash
sudo firewall-cmd --permanent --add-service=iscsi-target
sudo firewall-cmd --reload
```

### 3.5.2 iSCSI 서버 접속 종료

```Bash
exit
```

# 4. iSCSI initiator 구축

iSCSI target 서버가 네트워크를 통해 공유한 스토리지를 로컬 디스크처럼 사용하기 위해 구축합니다.

## 4.1 iSCSI initiator 서버 접속

```PowerShell
vagrant ssh WP-DB01
```

## 4.2 iSCSI initiator 패키지 설치 및 활성화

```Bash
sudo dnf install -y iscsi-initiator-utils
sudo systemctl enable --now iscsi
```

## 4.3 iSCSI target에 연결 및 확인

### 4.3.1 iSCSI initiator iqn 설정 및 적용

```Bash
echo "InitiatorName=iqn.2025-12.com.iscsi:wp-db01.initiator" | sudo tee /etc/iscsi/initiatorname.iscsi
sudo systemctl restart iscsid
```

- iSCSI target ACL에 등록된 이름인지 확인

### 4.3.2 iSCSI target 검색

```Bash
sudo iscsiadm -m discovery -t st -p 192.168.58.15:3260
```

```Plain Text
192.168.58.15:3260,1 iqn.2025-12.com.iscsi:wp-iscsi01.target
```

- 해당 IP/포트의 포털에 등록된 target 목록 검색
- 결과가 나오지 않으면 iSCSI target 방화벽이나 ACL 다시 확인 필요

### 4.3.3 iSCSI Portal 로그인

```Bash
sudo iscsiadm -m node -T iqn.2025-12.com.iscsi:wp-iscsi01.target -p 192.168.58.15 -l
```

```Plain Text
Login to [iface: default, target: iqn.2025-12.com.iscsi:wp-iscsi01.target, portal: 192.168.58.15,3260] successful. 
```

### 4.3.4 iSCSI Session 조회

```Bash
sudo iscsiadm -m session -o show 
```

```Plain Text
tcp: [1] 192.168.58.15:3260,1 iqn.2025-12.com.iscsi:wp-iscsi01.target (non-flash)
```

# 5. DB 서버 구축

데이터의 중앙 집중 관리를 통해 데이터 중복을 방지하고 체계적인 권한 제어와 백업 체계를 통해 데이터의 무결성을 보장하기 위해 구축합니다.

## 5.1 DB 서버 패키지 설치 및 활성화

```Bash
sudo dnf install -y mysql-server
sudo systemctl enable --now mysqld
```

- RHEL 9부터는 기본 AppStream에 MySQL 8.0이 포함되어있어서 `dnf install -y mysql-server` 만으로 바로 설치 가능
- 이전 버전은 MySQL 공식 repo 설치 필요(기본 repo에 MariaDB만 있음)

## 5.2 파일 시스템 생성

```Bash
lsblk
sudo mkfs.xfs /dev/sdb
```

- `lsblk` : sdb 존재 확인
-  XFS 사용 이유
	- 대용량 파일 및 스토리지를 위해 구성 -> DB 환경에 적합
	- 병렬 I/O 성능: 여러 프로세스가 동시에 디스크에 접근할 때 성능 저하가 적음
	- Rocky Linux 표준 파일 시스템
	- 유지보수: LUN 용량을 늘렸을 때 umount 없이 즉시 용량 확장 가능(xfs_growfs)

## 5.3 마운트

### 5.3.1 백업 파일 생성

```Bash
sudo mv /var/lib/mysql /var/lib/mysql.bak
sudo mkdir /var/lib/mysql
```

### 5.3.2 마운트

```Bash
sudo systemctl stop mysqld
sudo mount /dev/sdb /var/lib/mysql
sudo cp -rp /var/lib/mysql.bak/* /var/lib/mysql
```

- mysql 서비스 중지(파일 핸들 해제)
- DB 서버를 사용 중에 iSCSI를 마운트하는 상황이라면 백업 파일에서 데이터 가져오는 작업도 수행

### 5.3.3 소유권 및 권한 설정

```Bash
sudo chown -R mysql:mysql /var/lib/mysql
sudo chmod 751 /var/lib/mysql
```

### 5.3.4 부팅 시 자동 마운트 설정

```Bash
echo "/dev/sdb /var/lib/mysql xfs defaults,_netdev 0 0" | sudo tee -a /etc/fstab
```

- 디바이스명이 부팅 시 변경될 수 있기 때문에 고유 식별자인 UUID로 fstab에 등록 권고
	1. `sudo blkid /dev/sdb` 로 /dev/sdb UUID 확인
	2. fstab 파일에 /dev/sdb 대신 UUID=[확인한 UUID] 입력
- `/etc/fstab` 파일 내용 구조
	- /dev/sdb: 마운트할 디바이스(iSCSI LUN 장치명)
	- /var/lib/mysql: 마운트 지점(MySQL 데이터 저장 디렉토리)
	- xfs: 파일 시스템 타입(XFS 포맷)
	- defaults: rw,suid,dev,exec,auto,nouser,async(표준 옵션)
	- _netdev: 네트워크 의존(iSCSI이므로 네트워크 준비 후 마운트)
		- 0: dump 백업 생략
		- 0: fsck 점검 생략

### 5.3.5 마운트 테스트 및 mysql 활성화

```Bash
sudo mount -a
sudo systemctl start mysqld
sudo df -h | grep mysql
```

```Plain Text
/dev/sdb         10G  104M  9.9G   2% /var/lib/mysql
```

## 5.4 계정 생성

### 5.4.1 MySQL 접속

```Bash
sudo mysql -u root -p -h 127.0.0.1 #Enter password: 엔터 입력
```

### 5.4.2 데이터베이스 생성

```MySQL
CREATE DATABASE WP CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

- `CHARACTER SET utf8mb4`: 한글, 이모지, 특수문자 지원
- `COLLATE utf8mb4_unicode_ci`: 문자열 정렬, 비교 규칙(한국어 최적화)

### 5.4.3 계정 생성 및 권한 부여

```MySQL
CREATE USER 'wpus'@'192.168.58.11' IDENTIFIED BY 'Nobreak123!';
CREATE USER 'wpus'@'192.168.58.12' IDENTIFIED BY 'Nobreak123!';
GRANT ALL PRIVILEGES ON WP.* TO 'wpus'@'192.168.58.11';
GRANT ALL PRIVILEGES ON WP.* TO 'wpus'@'192.168.58.12';
```

### 5.4.4 권한 적용 및 확인

```MySQL
FLUSH PRIVILEGES;
SHOW GRANTS FOR 'wpus'@'192.168.58.11';
SHOW GRANTS FOR 'wpus'@'192.168.58.12';
exit
```

```Plain Text
+----------------------------------------------------------+
| Grants for wpus@[웹 서버 IP]                              |
+----------------------------------------------------------+
| GRANT USAGE ON *.* TO `wpus`@`[웹 서버 IP]`               |
| GRANT ALL PRIVILEGES ON `WP`.* TO `wpus`@`[웹 서버 IP]`   |
+----------------------------------------------------------+
```
## 5.5 보안 설정

### 5.5.1 SELinux 보안 컨텍스트 복원

```Bash
sudo restorecon -Rv /var/lib/mysql
```

### 5.5.2 방화벽 설정

```Bash
sudo firewall-cmd --permanent --add-service=mysql
sudo firewall-cmd --reload
exit # DB 서버 접속 종료
```


# 6. NFS 서버 구축

NFS(Network File System) 서버는 Web 1,2 서버 간 실시간 데이터 공유 효율성과 중앙화된 데이터 무결성 보장의 이유로 구축합니다.

## 6.1 NFS 서버 접속

```PowerShell
vagrant ssh WP-NFS01
```

## 6.2 NFS 패키지 설치 및 활성화

```Bash
sudo dnf install -y nfs-utils
sudo systemctl enable --now rpcbind nfs-server
```

- `rpcbind` 서비스
	- RPC(Remote Procedure Call)는 서비스 등록/중계를 담당함
	- NFS는 고정 포트가 아닌 동적 포트를 사용하기 때문에 클라이언트가 NFS 서버의 mountd, nfsd 등의 포트를 알 수 없음
	- rpcbind가 클라이언트 요청을 받아 해당 RPC 서비스로 연결함
	- 111번 포트 사용 및 TCP와 UDP 모두 지원

## 6.3 NFS 공유 디렉토리 설정 및 내보내기

### 6.3.1 NFS 공유 디렉토리 생성

```Bash
sudo mkfs.xfs /dev/sdb
sudo mkdir /WP-NFS01
sudo mount /dev/sdb /WP-NFS01
echo "/dev/sdb /WP-NFS01 xfs defaults 0 0" | sudo tee -a /etc/fstab
```

- sdb 디스크를 포맷하여 `/WP-NFS01` 디렉토리를 마운트
- `/etc/fstab`에 등록하여 부팅 시 자동 마운트 설정
- 디바이스명이 부팅 시 변경될 수 있기 때문에 고유 식별자인 UUID로 fstab에 등록 권고
	- 5.3.4 항목 참고

### 6.3.2 NFS 공유 디렉토리 권한 설정

```Bash
sudo chmod 755 /WP-NFS01
```

### 6.3.3 exports 파일 설정

```Bash
echo "/WP-NFS01 192.168.57.0/24(rw,sync,no_root_squash)" | sudo tee -a /etc/exports
```

- `/etc/exportfs`: NFS 서버에서 어떤 디렉토리를 어떤 클라이언트에 공유할지 정의하는 설정 파일
	- /WP-NFS01: 공유 디렉토리의 절대 경로
	- 192.168.57.0/24: 공유 디렉토리에 접근할 수 있는 IP 대역(단일 IP로 지정 가능)
	- (): 리소스 권한 
- `no_root_squash`: 클라이언트의 root 사용자를 서버에서도 root 권한으로 인정함
	- 변경하지 않고 기본값 `root_squash`를 사용할 경우
		- `sudo chown -R nobody:nobody /WP-NFS01` 설정 필요
		- 클라이언트의 root 사용자는 서버에서 nobody 권한으로 인정함

### 6.3.4 exports 파일 설정 반영 및 확인

```Bash
sudo exportfs -ra
sudo exportfs -v
```

- `exportfs -ra`
	- -r: `/etc/exports` 파일을 다시 읽어서 리스트를 갱신함
	- -a: 모든 디렉토리
	- **NFS 서비스를 재시작하지 않고도 바뀐 내용이 즉시 적용됨**
- `exportfx -v` 
	- /WP-NFS01 192.168.57.0/24(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash) 출력 확인

## 6.4 방화벽 설정

```Bash
sudo firewall-cmd --permanent --add-service={nfs,mountd,rpc-bind}
sudo firewall-cmd --reload
exit # NFS 서버 로그아웃
```

- NFS 버전별 방화벽 최소 필수 조건
	- NFSv4: nfs(2049/tcp)
	- NFSv3: nfs(2049), mountd, rpc-bind(111)

# 7. Web1,2 서버 구축

로드밸런싱과 고가용성 확보를 위해 웹 서버 2대를 구축합니다.

## 7.1 Web 서버 접속

```PowerShell
vagrant ssh WP-WEB01
```

## 7.2 웹 서버 패키지 설치 및 활성화

```Bash
sudo dnf install -y httpd php php-mysqlnd php-gd php-xml php-mbstring php-curl php-zip php-opcache
sudo systemctl enable --now httpd
```

- httpd: Apache HTTP 웹서버 (클라이언트 요청 처리)
- php: PHP 엔진 (WordPress 실행)
- php-mysqlnd: MySQL 데이터베이스 연결 (wp-config.php)
- php-gd: 이미지 처리(썸네일 생성/업로드)
- php-xml: XML 파싱(RSS, 플러그인, 테마)
- php-mbstring: 멀티바이트 문자열(한글/유니코드 처리)
- php-curl: HTTP 요청(테마/플러그인 자동 업데이트, 외부 API)
- php-zip: ZIP 압축/해제(플러그인 설치)
- php-opcache: PHP 바이트코드 캐싱(성능 최적화)

## 7.3 WordPress 다운로드 및 설정

### 7.3.1 WordPress 다운로드 및 압축 해제

```Bash
sudo curl -o wordpress.tar.gz https://wordpress.org/latest.tar.gz
sudo tar -xzf wordpress.tar.gz -C /var/www/html
```

### 7.3.2 WordPress 설정 파일 생성 및 소유주 변경

```Bash
sudo cp /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php
sudo chown -R apache:apache /var/www/html/wordpress/wp-config.php
```

### 7.3.3 WordPress 설정 파일 설정

`/var/www/html/wordpress/wp-config.php`
```Plain Text
define( 'DB_NAME', 'WP' );
define( 'DB_USER', 'wpus' );
define( 'DB_PASSWORD', 'Nobreak123!' );
define( 'DB_HOST', '192.168.58.13' );
```

## 7.4 웹 설정 파일

### 7.4.1 VirtualHost 설정 파일 생성

`/etc/httpd/conf.d/wordpress.conf`
```Plain Text
<VirtualHost *:80>
    ServerName 192.168.57.11 #WP-WEB02는 192.168.57.12
    DocumentRoot /var/www/html/wordpress
    
    <Directory /var/www/html/wordpress>
        Options Indexes FollowSymLinks
        AllowOverride none
        Require all granted
    </Directory>
</VirtualHost>
```

### 7.4.2 설정 반영

```Bash
sudo systemctl restart httpd
```

## 7.5 방화벽 설정

```Bash
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --reload
```

## 7.6 DB 연결 테스트

```Bash
mysql -u wpus -p -h 192.168.58.13 WP #Nobreak123!
exit
```

---
# 수정 전
## 7.2 apache, wordpress, mysql, nfs 패키지 설치
```Bash
sudo dnf install -y httpd php nfs-utils 
```

## 7.3 NFS 디렉토리 마운트
```
# 웹 서버의 데이터를 담을 디렉토리 생성
sudo mkdir -p /var/www/html

# NFS 서버 IP와 공유 디렉토리 연결
sudo mount -t nfs 192.168.57.14:/WP-NFS01 /var/www/html

# 부팅 시 자동 마운트 설정
echo "192.168.57.14:/WP-NFS01 /var/www/html nfs defaults 0 0" | sudo tee -a /etc/fstab
```

## 7.4 DB 연결 확인
```
mysql -u wpus -p -h 192.168.58.40
```

# 8. LB 구축
## 8.1 LB 서버 접속
```
vagrant ssh WP-LB01
```

## 8.2 HAProxy 패키지 설치 및 활성화
```
sudo dnf install -y haproxy

# 활성화
sudo systemctl enable --now haproxy
```

## 8.3 커널 파라미터 최적화
```
# IP 포워딩 및 비로컬 바인딩 허용
echo "net.ipv4.ip_forward = 1" | sudo tee -a /etc/sysctl.conf
echo "net.ipv4.ip_nonlocal_bind = 1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

## 8.4 HAProxy 설정
```
# 기존 파일 백업
sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak
sudo vi /etc/haproxy/haproxy.cfg
```

> /etc/haproxy/haproxy.cfg 파일 내부
> ```
> global 
> 	log /dev/log local0 
> 	log /dev/log local1 notice 
> 	chroot /var/lib/haproxy 
> 	stats socket /run/haproxy/admin.sock mode 660 level admin 
> 	stats timeout 30s 
> 	user haproxy 
> 	group haproxy 
> 	daemon 
> 	
> defaults 
> 	log global 
> 	mode http 
> 	option httplog 
> 	option dontlognull 
> 	timeout connect 5000 
> 	timeout client 50000 
> 	timeout server 50000 
> 	
> # 1. 모니터링 통계 페이지 (관리용) 
> listen stats 
> 	bind *:9000 
> 	stats enable 
> 	stats uri /haproxy_stats 
> 	stats auth admin:password123 # 실제 운영 시 변경 필수 
> 	
> # 2. 클라이언트가 접속하는 지점 (Frontend) 
> frontend http-in 
> 	bind 192.168.56.10:80 
> 	# X-Forwarded-For 헤더 추가 (웹서버에서 실제 클라이언트 IP 확인용) 
> 	option forwardfor 
> 	default_backend wp-cluster 
> 
> # 3. 실제 부하가 분산될 서버 군 (Backend) 
> backend wp-cluster 
> 	balance roundrobin 
> 	# WordPress 세션 유지를 위한 쿠키 설정 
> 	cookie SERVERID insert indirect nocache 
> 	
> 	# 서버 상태 체크(check) 포함 
> 	server web1 192.168.57.11:80 check cookie s1 
> 	server web2 192.168.57.12:80 check cookie s2
> ```

```
# 설정 검증
# "Configuration file is valid" 메시지가 나오면 성공
sudo haproxy -c -f /etc/haproxy/haproxy.cfg
```

## 8.5 방화벽 설정
```
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=9000/tcp
sudo firewall-cmd --reload
```