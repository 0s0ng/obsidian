# 고가용성 웹 서비스 구축

# 1. 목표

![시나리오03 아키텍쳐](/images/scenario03_architecture.png)

WP-WEB01과 WP-WEB02에 웹 서버를 구축합니다. 구성 요소는 아래와 같습니다.

- Apache HTTP Server
- PHP
- WordPress

WP-LB01에 로드밸런서를 구축합니다. 구성 요소는 아래와 같습니다.

- HAProxy

WP-DB01에 DB 서버를 구축합니다. 구성 요소는 아래와 같습니다.

- MySQL

# 2. 환경 설정

## 2.1 Vagrantfile

- Vagrantfile

```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

BOX_NAME = "nobreak-labs/rocky-9"
MEMORY = "2048"
CPUS = 2

NODES = {
  "WP-LB01" => {
    networks: [
      { ip: "192.168.56.10" },
      { ip: "192.168.57.10" }
    ]
  },

  "WP-WEB01" => {
    networks: [
      { ip: "192.168.57.20" },
      { ip: "192.168.58.20" }
    ]
  },

  "WP-WEB02" => {
    networks: [
      { ip: "192.168.57.30" }, 
      { ip: "192.168.58.30" }  
    ]
  },

  "WP-DB01" => {
    networks: [
      { ip: "192.168.58.40" }
    ]
  }
}

Vagrant.configure("2") do |config|
  NODES.each do |node_name, node_config|
    config.vm.define node_name do |node|
      node.vm.box = BOX_NAME

      node_config[:networks].each do |network|
        node.vm.network "private_network", ip: network[:ip]
      end

      node.vm.synced_folder ".", "/vagrant", disabled: true

      node.vm.provider "virtualbox" do |vb|
        vb.memory = MEMORY
        vb.cpus = CPUS
        vb.name = node_name
      end

      node.vm.hostname = node_name
    end
  end
end

```

## 2.2 네트워크 및 서비스

| VM | Subnet | Zone | Service | IP |
| --- | --- | --- | --- | --- |
| WP-LB01 | 192.168.56.0/24<br>192.168.57.0/24 | Public<br>internal | HAProxy | 192.168.56.10<br>192.168.57.10 |
| WP-WEB01 | 192.168.57.0/24<br>192.168.58.0/24 | internal | Web | 192.168.57.20<br>192.168.58.20 |
| WP-WEB02 | 192.168.57.0/24<br>192.168.58.0/24 | internal | Web | 192.168.57.30<br>192.168.58.30 |
| WP-DB01 | 192.168.58.0/24 | internal | DB | 192.168.58.40 |

# 3. WP-WEB01

WordPress 웹 구성에 필요한 패키지 설치 및 소스 다운로드와 기타 설정을 수행합니다.

## 3.1 의존성 패키지 설치

```bash
sudo dnf install httpd php php-mysqlnd mysql -y
```

httpd, php, php-mysqlnd, mysql 패키지 설치

## 3.2 WordPress 설치

WordPress 소스 파일 다운로드 및 설치를 진행하고 압축을 해제합니다.

### 3.2.1 WordPress 소스 다운로드

```bash
curl -o wordpress.tar.gz https://wordpress.org/wordpress-6.8.2.tar.gz
```

WordPress 소스 다운로드 후 wordpress.tar.gz 라는 이름으로 현재 디렉토리에 저장

### 3.2.2 WordPress 압축 해제

```bash
sudo tar -xzf wordpress.tar.gz -C /var/www/html
```

- 다운로드 받은 WordPress 소스 파일 압축 해제
- `/var/www/html`에 압축 해제


## 3.3 WordPress 설정

WordPress 설정 파일을 구성합니다.

### 3.3.1 WordPress 설정 파일 수정

```bash
sudo cp /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php
```

WordPress를 다운로드 하면 자동으로 생성 되는 wp-config-sample.php 샘플 파일을 복사하여 실제 설정 파일로 만듭니다. 내용은 아래와 같습니다.

`/var/www/html/wordpress/wp-config.php`

```bash
define( 'DB_NAME', 'WP' );
define( 'DB_USER', 'wpus' );
define( 'DB_PASSWORD', 'Nobreak123!' );
define( 'DB_HOST', '192.168.58.40' );
```

- WordPress가 사용할 데이터베이스 명
- 데이터베이스에 접속할 때 사용할 사용자 명
- 데이터베이스 사용자의 비밀번호
- 접속할 DB 서버 IP

### 3.3.2 DocumentRoot 변경

`/etc/httpd/conf.d/wordpress.conf`

```bash
<VirtualHost *:80>
    ❶ServerName 192.168.56.10
    ❷DocumentRoot /var/www/html/wordpress
    <Directory /var/www/html/wordpress>
        ❸AllowOverride All
        ❹Require all granted
    </Directory>
</VirtualHost>
```

위의 내용은 웹 서버에 접속하기 위한 URL을 변경하고, 파일을 제공하는 최상위 디렉토리를 지정하기 위한 작업
- ❶: 로드밸런서의 Public IP
- ❷: 웹 컨텐츠가 저장된 루트 폴더
- ❸: Apache 설정 파일인 htaccess 파일의 지시문 허용 옵션
- ❹: 해당 디렉토리에 대한 모든 요청(IP 주소 등)에 대한 접근 제어 옵션

## 3.4 기타 설정

### 3.4.1 httpd(Apache HTTP Server) 활성화

```bash
sudo systemctl enable httpd --now
```

설정 적용과 정상 동작을 위한 httpd(Apache HTTP Server)서비스 활성화

### 3.4.2 방화벽 설정

```bash
sudo firewall-cmd --add-service=http --permanent
sudo firewall-cmd --reload
```
-  외부와 통신하기 위한 80번 포트를 영구적으로 개방
-  설정 적용을 위한 방화벽 재시작

### 3.4.3 외부 IP DB접속 허용

```bash
sudo setsebool -P httpd_can_network_connect_db 1
```

웹 서버가 네트워크(원격)를 통해 데이터베이스에 접속할 수 있도록 SELinux의 **원격 접속 차단 정책**을 해제하는 작업. 현재 아키텍쳐에서는 데이터베이스와 내부망(192.168.58.0/24)과 통신하므로 위의 작업이 필요함

> 허용된 프로세스만 허용된 포트와 프로토콜로 통신할 수 있다는 원칙에 따른 SELinux 정책

# 4. WP-WEB02

WP-WEB01과 동일하게 웹 서버를 구축합니다.

## 4.1 의존성 패키지 설치

```bash
sudo dnf install httpd php php-mysqlnd mysql -y
```

httpd, php, php-mysqlnd, mysql 패키지 설치

## 4.2 WordPress 설치

WordPress 소스 파일 다운로드 및 설치를 진행하고 압축을 해제합니다.

### 4.2.1 WordPress 소스 다운로드

```bash
curl -o wordpress.tar.gz https://wordpress.org/wordpress-6.8.2.tar.gz
```

WordPress 소스 다운로드 후 wordpress.tar.gz 라는 이름으로 현재 디렉토리에 저장

### 4.2.2 WordPress 압축 해제

```bash
sudo tar -xzf wordpress.tar.gz -C /var/www/html
```

- 다운로드 받은 WordPress 소스 파일 압축 해제
- `/var/www/html`에 압축 해제

## 4.3 WordPress 설정

WordPress 설정 파일을 구성합니다.

### 4.3.1 WordPress 설정 파일 수정

```bash
sudo cp /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php
```

WordPress를 다운로드 하면 자동으로 생성 되는 wp-config-sample.php 샘플 파일을 복사하여 실제 설정 파일로 만듭니다. 내용은 아래와 같습니다.

`/var/www/html/wordpress/wp-config.php`

```bash
define( 'DB_NAME', 'WP' );
define( 'DB_USER', 'wpus' );
define( 'DB_PASSWORD', 'Nobreak123!' );
define( 'DB_HOST', '192.168.58.40' );
```

- WordPress가 사용할 데이터베이스 명
- 데이터베이스에 접속할 때 사용할 사용자 명
- 데이터베이스 사용자의 비밀번호
- 접속할 DB 서버 IP

### 4.3.2 DocumentRoot 변경

`/etc/httpd/conf.d/wordpress.conf`

```bash
<VirtualHost *:80>
    ❶ServerName 192.168.56.10
    ❷DocumentRoot /var/www/html/wordpress
    <Directory /var/www/html/wordpress>
        ❸AllowOverride All
        ❹Require all granted
    </Directory>
</VirtualHost>
```

위의 내용은 웹 서버에 접속하기 위한 URL을 변경하고, 파일을 제공하는 최상위 디렉토리를 지정하기 위한 작업
- ❶: 로드밸런서의 Public IP
- ❷: 웹 컨텐츠가 저장된 루트 폴더
- ❸: Apache 설정 파일인 htaccess 파일의 지시문 허용 옵션
- ❹: 해당 디렉토리에 대한 모든 요청(IP 주소 등)에 대한 접근 제어 옵션

## 4.4 기타 설정

### 4.4.1 httpd(Apache HTTP Server) 활성화

```bash
sudo systemctl enable httpd --now
```

설정 적용과 정상 동작을 위한 httpd(Apache HTTP Server)서비스 활성화

### 4.4.2 방화벽 설정

```bash
sudo firewall-cmd --add-service=http --permanent
sudo firewall-cmd --reload
```
-  외부와 통신하기 위한 80번 포트를 영구적으로 개방
-  설정 적용을 위한 방화벽 재시작

### 4.4.3 외부 IP DB접속 허용

```bash
sudo setsebool -P httpd_can_network_connect_db 1
```

웹 서버가 네트워크(원격)를 통해 데이터베이스에 접속할 수 있도록 SELinux의 **원격 접속 차단 정책**을 해제하는 작업. 현재 아키텍쳐에서는 데이터베이스와 내부망(192.168.58.0/24)과 통신하므로 위의 작업이 필요함

> 허용된 프로세스만 허용된 포트와 프로토콜로 통신할 수 있다는 원칙에 따른 SELinux 정책

# 5. WP-LB01

위에 작업했던 웹 서버 두 개를 로드밸런싱 하기 위한 로드밸런서를 구축합니다.

## 5.1 의존성 패키지 설치

```bash
sudo dnf install haproxy -y
```

haproxy 패키지 설치

## 5.2 haproxy 설정 파일 수정

`/etc/haproxy/haproxy.cfg`

```bash
frontend main
❶ bind *:80
default_backend      webservers 
--------------------------------------
backend webservers
❷ balance roundrobin
❸ server web01 192.168.57.20:80 check
❹ server web02 192.168.57.30:80 check
```

- ❶: HAProxy가 80번 포트에서 사용자의 웹 요청 수신
- ❷: roundrobin(순차 방식)을 사용하여, 두 개의 웹 서버에 트래픽을 번갈아 가며 분산
- ❸: `web01`이라는 이름으로 첫 번째 웹 서버(WP-WEB01)를 등록하고 서버가 정상 작동하는지 헬스 체크 활성화
- ❹: `web02`이라는 이름으로 두 번째 웹 서버(WP-WEB02)를 등록하고 서버가 정상 작동하는지 헬스 체크 활성화

❸,❹번의 서버 헬스 체크로 서버에 장애 발생 시, 정상 동작하는 웹 서버에 트래픽 전달

## 5.3 haproxy 시작 및 활성화

```bash
sudo systemctl enable haproxy --now
```

설정 적용을 위해 haproxy 서비스 활성화

## 5.4 방화벽 설정

```bash
sudo firewall-cmd --add-service=http --permanent
sudo firewall-cmd --reload
```

80포트를 열어서 외부와의 접속을 허용합니다.

# 6. WP-DB01

데이터베이스 서버 구성을 위한 패키지 설치 및 MySQL 설정을 수행하고 테스트를 진행합니다.

## 6.1 의존성 패키지 설치

```bash
sudo dnf install mysql-server -y
```

mysql-server 패키지 설치

## 6.2 MySQL 구성

MySQL 설정 및 데이터베이스 구성을 합니다.

### 6.2.1 MySQL 시작 및 활성화

```bash
sudo systemctl enable mysqld --now
```

`mysql_secure_installation`스크립트 실행을 위해 MySQL 서비스 활성화

### 6.2.2 DB 보안 설정

```bash
sudo mysql_secure_installation
```

`mysql_secure_installation`은 MySQL 서버를 안전하게 운영하기 위해 기본적으로 설정해야 할 여러 보안 옵션을 설정할 수 있는 명령입니다.

#### 6.2.2.1 mysql_secure_installation 설정 과정

```bash
Connecting to MySQL using a blank password.
```

현재 비밀번호가 없는 상태라 자동 연결

```bash
Would you like to setup VALIDATE PASSWORD component?

Press y|Y for Yes, any other key for No:
```

패스워드의 복잡성을 검증하는 모듈을 활성화하는 스크립트

패스워드의 복잡성을 검증하는 모듈을 활성화하기 위해 `y` 입력

```bash
There are three levels of password validation policy:

LOW    Length >= 8
MEDIUM Length >= 8, numeric, mixed case, and special characters
STRONG Length >= 8, numeric, mixed case, special characters and dictionary file

Please enter 0 = LOW, 1 = MEDIUM, 2 = STRONG:
```
- 0(LOW) = 8글자 이상
- 1(MEDIUM) = 8글자 이상, 숫자, 대소문자, 특수문자 포함
- 2(STRONG) = MEDIUM 기준에 더해 사전파일에 있는 일반적인 단어(password,admin 등) 사용 불가  

가장 강한 패스워드 복잡성 모듈을 사용하기 위해 `2` 입력

```bash
New password: (Nobreak123!)
```

MySQL root 사용자의 비밀번호 설정

```bash
Re-enter new password: (Nobreak123!)
```

설정한 비밀번호 재입력(확인)

```bash
Estimated strength of the password: 100
Do you wish to continue with the password provided?(Press y|Y for Yes, any other key for No) :
```
위 스크립트에서 설정한 비밀번호 예상 강도가 100점 이라는 뜻으로 추측하거나 해킹하기 매우 어렵다는 것을 의미

위에서 설정한 비밀번호로 계속해서 다음 단계를 진행하기 위해 `y` 입력

```bash
Remove anonymous users?

(Press y|Y for Yes, any other key for No) :
```
**익명의 유저** 계정 삭제 스크립트

> 익명의 유저란 데이터베이스 관리 시스템(MySQL, MariaDB 등)을 처음 설치하면 익명의 유저 계정이 자동으로 생성이 되는데, 비밀번호 없이 데이터베이스에 접근이 가능하기 때문에 보안적으로 취약함

익명의 유저 계정은 테스트 용도로 사용되거나 비밀번호 없이 접근할 수 있는 편리함을 가지고 있어 일부 개발자들이 사용하고 있지만, 해커들의 공격 통로로 이용될 수 있기 때문에 삭제 조치가 권장되고 있음

보안에 취약한 익명의 계정을 삭제하기 위해 `y` 입력

```bash
Disallow root login remotely?

(Press y|Y for Yes, any other key for No) :
```
MySQL root 계정에 대한 원격 접속을 차단하는 스크립트 

MySQL root 계정은 데이터베이스 서버에 대한 최고 관리자 권한을 가지고 있으므로, 원격으로 접속할 수 있게 된다면 심각한 보안 사고를 초래할 수 있기 때문에 데이터베이스 서버의 localhost에서만 접속할 수 있도록 조치하는 것이 권장되고 있음

MySQL root 계정에 대한 원격 접속을 차단하기 위해 `y` 입력

```bash
Remove test database and access to it?

(Press y|Y for Yes, any other key for No) :
```

`test` 데이터베이스를 삭제하는 스크립트

데이터베이스 관리 시스템(MySQL, MariaDB 등)을 처음 설치하면 자동으로 생성되는 `test` 데이터베이스는 별도의 설정 없이도 바로 연습, 테스트 등을 할 수 있도록 기본 환경을 제공하는데, 이는 해커들의 잠재적인 진입점이 될 수 있기 때문에 삭제 조치가 권장되고 있음

`test` 데이터베이스를 삭제하기 위해 `y` 입력

```bash
Reload privilege tables now?

(Press y|Y for Yes, any other key for No) :
```
현재까지 설정한 사항을 적용하기 위한 스크립트

현재까지 설정한 사항을 적용하기 위해 `y` 입력

### 6.2.3 DB 생성 및 사용자 생성

```bash
sudo mysql -u root -p
```
`mysql_secure_installation` 에서 설정한 비밀번호를 입력하고 MySQL root 사용자로 접속합니다.

```sql
CREATE